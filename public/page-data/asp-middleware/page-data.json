{"componentChunkName":"component---src-templates-blog-post-js","path":"/asp-middleware/","result":{"data":{"site":{"siteMetadata":{"title":"Chris Hibler"}},"markdownRemark":{"id":"16a7f214-3bd0-5ab2-bd35-a91d0ee765bf","excerpt":"Creating Request Logging Middleware in ASP.NET Core Middleware in ASP.NET Core allows you to handle HTTP requests and responses at various stages of their…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/341cc5a139a727352f2f13448444adfc/7f403/logging-dashboard.webp\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.49367088607595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/webp;base64,UklGRmYAAABXRUJQVlA4IFoAAACwAwCdASoUAAwAPtFUo0uoJKMhsAgBABoJZQCdACIABL+lWN/ugAD+wHzsjEGa9aLvjhNCs7duVRHoPgVYGjBSwovS/JtIRB9DiTllxQhU6acbt9LKeJQAAAA='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Request Dashboard\"\n        title=\"\"\n        src=\"/static/341cc5a139a727352f2f13448444adfc/8aab1/logging-dashboard.webp\"\n        srcset=\"/static/341cc5a139a727352f2f13448444adfc/81b7c/logging-dashboard.webp 158w,\n/static/341cc5a139a727352f2f13448444adfc/6ea66/logging-dashboard.webp 315w,\n/static/341cc5a139a727352f2f13448444adfc/8aab1/logging-dashboard.webp 630w,\n/static/341cc5a139a727352f2f13448444adfc/a70f5/logging-dashboard.webp 945w,\n/static/341cc5a139a727352f2f13448444adfc/4ef06/logging-dashboard.webp 1260w,\n/static/341cc5a139a727352f2f13448444adfc/7f403/logging-dashboard.webp 1400w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1>Creating Request Logging Middleware in ASP.NET Core</h1>\n<p>Middleware in ASP.NET Core allows you to handle HTTP requests and responses at various stages of their lifecycle. Logging incoming requests can be incredibly useful for debugging, auditing, or monitoring your application’s performance. In this post, we’ll walk through creating custom request logging middleware for an ASP.NET Core application.</p>\n<h3>What is Middleware?</h3>\n<p>Middleware in ASP.NET Core is software that’s assembled into an application pipeline to handle requests and responses. Each middleware component chooses whether to pass the request to the next component in the pipeline and can perform actions before or after the next component processes the request.</p>\n<h3>Setting Up Your Project</h3>\n<p>To get started, make sure you have the .NET SDK installed. You can create a new ASP.NET Core project with the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dotnet new webapi <span class=\"token parameter variable\">-n</span> RequestLoggingDemo</code></pre></div>\n<h1>Navigate to the project directory:</h1>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> RequestLoggingDemo</code></pre></div>\n<h1>Step 1: Create the Middleware</h1>\n<p>First, create a new file called <code class=\"language-text\">RequestLoggingMiddleware.cs</code> in the root of your project (or in a Middleware folder if you prefer to organize your code).</p>\n<p>Here’s the code for the middleware:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>AspNetCore<span class=\"token punctuation\">.</span>Http</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Threading<span class=\"token punctuation\">.</span>Tasks</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>IO</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span>Logging</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RequestLoggingMiddleware</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RequestDelegate</span> next<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ILogger<span class=\"token punctuation\">&lt;</span>RequestLoggingMiddleware<span class=\"token punctuation\">></span></span> logger<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">InvokeAsync</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpContext</span> context<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        context<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">.</span><span class=\"token function\">EnableBuffering</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// Read the request body (if present)</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> requestBody<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StreamReader</span><span class=\"token punctuation\">(</span>\n            context<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">,</span>\n            <span class=\"token named-parameter punctuation\">encoding</span><span class=\"token punctuation\">:</span> System<span class=\"token punctuation\">.</span>Text<span class=\"token punctuation\">.</span>Encoding<span class=\"token punctuation\">.</span>UTF8<span class=\"token punctuation\">,</span>\n            <span class=\"token named-parameter punctuation\">detectEncodingFromByteOrderMarks</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n            <span class=\"token named-parameter punctuation\">bufferSize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">,</span>\n            <span class=\"token named-parameter punctuation\">leaveOpen</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            requestBody <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> reader<span class=\"token punctuation\">.</span><span class=\"token function\">ReadToEndAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            context<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">.</span>Position <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Reset stream position</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// Log the request details</span>\n        _logger<span class=\"token punctuation\">.</span><span class=\"token function\">LogInformation</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"HTTP </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">context<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">.</span>Method</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">context<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">.</span>Path</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">context<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">.</span>QueryString</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\\nBody: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">requestBody</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// Call the next middleware in the pipeline</span>\n        <span class=\"token keyword\">await</span> <span class=\"token function\">_next</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h3>Step 2: Add the Middleware to the Pipeline</h3>\n<p>In ASP.NET Core, middleware is added to the pipeline in the Program.cs file. Update your Program.cs to include the middleware:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> WebApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Add services to the container.</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddControllers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Add logging</span>\nbuilder<span class=\"token punctuation\">.</span>Logging<span class=\"token punctuation\">.</span><span class=\"token function\">AddConsole</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> app <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Add custom middleware</span>\napp<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">UseMiddleware</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>RequestLoggingMiddleware<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Configure the HTTP request pipeline</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">.</span>Environment<span class=\"token punctuation\">.</span><span class=\"token function\">IsDevelopment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">UseDeveloperExceptionPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">UseHttpsRedirection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">UseAuthorization</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapControllers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Step 3: Run and Test</h3>\n<p>Run your application using the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">dotnet run</code></pre></div>\n<p>Send a request to your API using a tool like Postman or curl. For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST https://localhost:5001/api/values <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'{\"key\": \"value\"}'</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span></code></pre></div>\n<p>Check your console logs to see the logged request details:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">info: RequestLoggingMiddleware[0]\nHTTP POST /api/values\nBody: {\"key\": \"value\"}</code></pre></div>\n<h3>Customizing the Middleware</h3>\n<p>You can enhance the middleware to log additional information, such as headers or response details. For example, you could log the status code and response body by wrapping _next(context) in a try-finally block and capturing the response stream.</p>\n<h3>Conclusion</h3>\n<p>Creating custom middleware in ASP.NET Core is a straightforward way to extend the functionality of your application. With request logging middleware, you can gain better insights into the requests your application handles, making debugging and monitoring easier. Try experimenting with this middleware and customize it to suit your specific needs!</p>","frontmatter":{"title":"ASP.NET Request Logging Middleware","date":"January 20, 2025","description":"How to use ASP.NET Core middleware for request logging."}},"previous":{"fields":{"slug":"/new-beginnings/"},"frontmatter":{"title":"New Beginnings"}},"next":null},"pageContext":{"id":"16a7f214-3bd0-5ab2-bd35-a91d0ee765bf","previousPostId":"09d1286b-873e-57c2-bce7-956dafccf696","nextPostId":null}},"staticQueryHashes":["1986508952","2841359383"],"slicesMap":{}}